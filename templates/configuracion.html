{% extends "base.html" %}

{% block title %}Configuraci√≥n - Iberdrola AI{% endblock %}

{% block content %}
<div class="use-case-container">
    <!-- Editor de Men√∫ -->
    <div class="card">
        <div class="card-header">
            <h2>üìù Editor de Men√∫ de Navegaci√≥n</h2>
            <p style="font-size: 14px; color: var(--neutral-foreground-3); margin-top: 8px;">
                Personaliza los nombres y t√≠tulos del men√∫. Los cambios se guardan autom√°ticamente.
            </p>
        </div>
        <div class="card-body">
            <div id="menu-editor">
                <!-- Dashboard -->
                <div class="menu-editor-section">
                    <h3 class="menu-editor-title">Dashboard</h3>
                    <div class="menu-editor-item">
                        <div class="form-group">
                            <label>Nombre en Men√∫</label>
                            <input type="text" class="form-control" 
                                   data-config-path="dashboard.menu_name" 
                                   value="{{ menu_config.dashboard.menu_name }}">
                        </div>
                        <div class="form-group">
                            <label>T√≠tulo de P√°gina</label>
                            <input type="text" class="form-control" 
                                   data-config-path="dashboard.page_title" 
                                   value="{{ menu_config.dashboard.page_title }}">
                        </div>
                    </div>
                </div>

                <!-- Categor√≠as -->
                {% for category in menu_config.categories %}
                {% set category_index = loop.index0 %}
                <div class="menu-editor-section">
                    <h3 class="menu-editor-title">
                        <input type="text" class="form-control category-title-input" 
                               data-config-path="categories.{{ category_index }}.title" 
                               value="{{ category.title }}">
                    </h3>
                    
                    {% for item in category.menu_items %}
                    <div class="menu-editor-item">
                        <div class="menu-item-header">
                            <span class="menu-item-icon">{{ item.icon }}</span>
                            <span class="menu-item-endpoint">{{ item.endpoint }}</span>
                        </div>
                        <div class="form-group">
                            <label>Nombre en Men√∫</label>
                            <input type="text" class="form-control" 
                                   data-config-path="categories.{{ category_index }}.menu_items.{{ loop.index0 }}.menu_name" 
                                   value="{{ item.menu_name }}">
                        </div>
                        <div class="form-group">
                            <label>T√≠tulo de P√°gina</label>
                            <input type="text" class="form-control" 
                                   data-config-path="categories.{{ category_index }}.menu_items.{{ loop.index0 }}.page_title" 
                                   value="{{ item.page_title }}">
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}

                <!-- Configuraci√≥n -->
                <div class="menu-editor-section">
                    <h3 class="menu-editor-title">Configuraci√≥n</h3>
                    <div class="menu-editor-item">
                        <div class="form-group">
                            <label>Nombre en Men√∫</label>
                            <input type="text" class="form-control" 
                                   data-config-path="configuracion.menu_name" 
                                   value="{{ menu_config.configuracion.menu_name }}">
                        </div>
                        <div class="form-group">
                            <label>T√≠tulo de P√°gina</label>
                            <input type="text" class="form-control" 
                                   data-config-path="configuracion.page_title" 
                                   value="{{ menu_config.configuracion.page_title }}">
                        </div>
                    </div>
                </div>
            </div>

            <div class="menu-editor-actions">
                <button id="save-menu-config" class="btn btn-primary">
                    üíæ Guardar Configuraci√≥n
                </button>
                <button id="reset-menu-config" class="btn btn-secondary">
                    üîÑ Restaurar Valores por Defecto
                </button>
                <div id="save-status" class="save-status"></div>
            </div>
        </div>
    </div>

    <!-- Vista del Men√∫ -->
    <div class="card">
        <div class="card-header">
            <h2>üóÇÔ∏è Organizaci√≥n del Men√∫</h2>
            <p style="font-size: 14px; color: var(--neutral-foreground-3); margin-top: 8px;">
                Configura c√≥mo se agrupan los casos de uso en el men√∫ lateral
            </p>
        </div>
        <div class="card-body">
            <div class="menu-view-selector">
                <div class="view-option" data-view="category">
                    <div class="view-option-header">
                        <input type="radio" name="menu_view" id="view_category" value="category" 
                               {% if menu_config.menu_view_mode == 'category' %}checked{% endif %}>
                        <label for="view_category">
                            <strong>üìÅ Por Categor√≠a</strong>
                        </label>
                    </div>
                    <p class="view-option-description">
                        Agrupa los casos de uso seg√∫n el esquema Iberdrola: Benchmark, Insights y Aprendizajes, Estudio Creativo, Content Automation, Brand Guardian
                    </p>
                    <div class="view-option-preview">
                        <div class="preview-item">1Ô∏è‚É£ Benchmark</div>
                        <div class="preview-subitem">‚Üí Monitorizaci√≥n de marca</div>
                        <div class="preview-item">2Ô∏è‚É£ Insights y Aprendizajes</div>
                        <div class="preview-subitem">‚Üí Predicci√≥n, Segmentaci√≥n, Atribuci√≥n</div>
                        <div class="preview-item">3Ô∏è‚É£ Estudio Creativo</div>
                        <div class="preview-subitem">‚Üí Generaci√≥n con GenAI</div>
                    </div>
                </div>

                <div class="view-option" data-view="roadmap">
                    <div class="view-option-header">
                        <input type="radio" name="menu_view" id="view_roadmap" value="roadmap"
                               {% if menu_config.menu_view_mode == 'roadmap' %}checked{% endif %}>
                        <label for="view_roadmap">
                            <strong>üöÄ Por Roadmap</strong>
                        </label>
                    </div>
                    <p class="view-option-description">
                        Agrupa los casos de uso por fase de implementaci√≥n: Quick Wins (A√±o 1) vs A√±o 2+
                    </p>
                    <div class="view-option-preview">
                        <div class="preview-item" style="color: #10b981;">üöÄ Quick Wins (A√±o 1)</div>
                        <div class="preview-subitem">‚Üí 4 casos de uso de r√°pida implementaci√≥n</div>
                        <div class="preview-item" style="color: #3b82f6;">üéØ A√±o 2+ Wins</div>
                        <div class="preview-subitem">‚Üí 6 casos de uso estrat√©gicos</div>
                    </div>
                </div>
            </div>

            <div class="roadmap-info-box">
                <h4>üìã Distribuci√≥n por Roadmap:</h4>
                <div class="roadmap-distribution">
                    <div class="roadmap-group quick-wins">
                        <h5>üöÄ Quick Wins (A√±o 1)</h5>
                        <ul>
                            <li>üì° Monitorizaci√≥n de marca <span style="opacity:0.6">(Benchmark)</span></li>
                            <li>‚úçÔ∏è Generaci√≥n de contenido con GenAI <span style="opacity:0.6">(Estudio Creativo)</span></li>
                            <li>üß™ A/B Testing Automatizado <span style="opacity:0.6">(Content Automation)</span></li>
                            <li>üí¨ Agentes Conversacionales <span style="opacity:0.6">(Brand Guardian)</span></li>
                        </ul>
                        <p class="roadmap-note">Baja dependencia de datos ‚Ä¢ Implementaci√≥n r√°pida ‚Ä¢ Valor inmediato</p>
                    </div>
                    <div class="roadmap-group year-2-plus">
                        <h5>üéØ A√±o 2+ Wins</h5>
                        <ul>
                            <li>üìà Predicci√≥n de abandonos <span style="opacity:0.6">(Insights y Aprendizajes)</span></li>
                            <li>üîç Segmentaci√≥n de clientes <span style="opacity:0.6">(Insights y Aprendizajes)</span></li>
                            <li>üîó Modelos de atribuci√≥n <span style="opacity:0.6">(Insights y Aprendizajes)</span></li>
                            <li>üë§ Personalizaci√≥n de experiencias <span style="opacity:0.6">(Content Automation)</span></li>
                            <li>üéÅ Motor de recomendaciones <span style="opacity:0.6">(Content Automation)</span></li>
                            <li>üéØ Optimizaci√≥n Publicitaria <span style="opacity:0.6">(Brand Guardian)</span></li>
                        </ul>
                        <p class="roadmap-note">Alta dependencia de datos ‚Ä¢ Integraci√≥n profunda ‚Ä¢ Visi√≥n estrat√©gica</p>
                    </div>
                </div>
            </div>

            <button id="save-menu-view" class="btn btn-primary">
                üíæ Aplicar Vista de Men√∫
            </button>
            <div id="view-save-status" class="save-status"></div>
        </div>
    </div>

    <!-- Configuraci√≥n General -->
    <div class="card">
        <div class="card-header">
            <h2>‚öôÔ∏è Configuraci√≥n General</h2>
        </div>
        <div class="card-body">
            <form>
                <div class="form-group">
                    <label>Nombre de la Empresa</label>
                    <input type="text" class="form-control" value="Iberdrola Espa√±a">
                </div>
                <div class="form-group">
                    <label>Idioma</label>
                    <select class="form-control">
                        <option selected>Espa√±ol</option>
                        <option>English</option>
                        <option>Portugu√™s</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Zona Horaria</label>
                    <select class="form-control">
                        <option selected>Europe/Madrid (GMT+1)</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Guardar Cambios</button>
            </form>
        </div>
    </div>

    <!-- Seguridad -->
    <div class="card">
        <div class="card-header">
            <h2>üîí Seguridad y Privacidad</h2>
        </div>
        <div class="card-body">
            <div class="security-item">
                <div>
                    <strong>Autenticaci√≥n de Dos Factores</strong>
                    <p>Protege tu cuenta con verificaci√≥n adicional</p>
                </div>
                <label class="toggle">
                    <input type="checkbox" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="security-item">
                <div>
                    <strong>Certificaci√≥n ISO/IEC 42001</strong>
                    <p>Sistema de Gesti√≥n de IA Certificado</p>
                </div>
                <span class="badge badge-success">‚úì Activo</span>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const saveBtn = document.getElementById('save-menu-config');
    const resetBtn = document.getElementById('reset-menu-config');
    const saveStatus = document.getElementById('save-status');
    const saveViewBtn = document.getElementById('save-menu-view');
    const viewSaveStatus = document.getElementById('view-save-status');
    
    // Guardar vista de men√∫
    saveViewBtn.addEventListener('click', async function() {
        const selectedView = document.querySelector('input[name="menu_view"]:checked').value;
        
        try {
            const response = await fetch('/api/set-menu-view', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ view_mode: selectedView })
            });
            
            if (response.ok) {
                viewSaveStatus.innerHTML = '<span style="color: var(--success-color);">‚úì Vista aplicada correctamente</span>';
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                viewSaveStatus.innerHTML = '<span style="color: var(--error-color);">‚úó Error al cambiar vista</span>';
            }
        } catch (error) {
            viewSaveStatus.innerHTML = '<span style="color: var(--error-color);">‚úó Error de conexi√≥n</span>';
        }
    });
    
    // Guardar configuraci√≥n
    saveBtn.addEventListener('click', async function() {
        const inputs = document.querySelectorAll('#menu-editor input[data-config-path]');
        const config = {{ menu_config|tojson }};
        
        // Actualizar configuraci√≥n con los valores de los inputs
        inputs.forEach(input => {
            const path = input.dataset.configPath.split('.');
            let obj = config;
            
            for (let i = 0; i < path.length - 1; i++) {
                obj = obj[path[i]];
            }
            
            obj[path[path.length - 1]] = input.value;
        });
        
        // Enviar al servidor
        try {
            const response = await fetch('/api/save-menu-config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(config)
            });
            
            if (response.ok) {
                saveStatus.innerHTML = '<span style="color: var(--success-color);">‚úì Guardado correctamente</span>';
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                saveStatus.innerHTML = '<span style="color: var(--error-color);">‚úó Error al guardar</span>';
            }
        } catch (error) {
            saveStatus.innerHTML = '<span style="color: var(--error-color);">‚úó Error de conexi√≥n</span>';
        }
    });
    
    // Restaurar valores por defecto
    resetBtn.addEventListener('click', function() {
        if (confirm('¬øEst√°s seguro de que quieres restaurar los valores por defecto?')) {
            fetch('/api/reset-menu-config', {
                method: 'POST'
            }).then(() => {
                window.location.reload();
            });
        }
    });
});
</script>

<!-- Incluir Asistente Virtual Fijo -->
{% include 'asistente_panel_fijo.html' %}

{% endblock %}
