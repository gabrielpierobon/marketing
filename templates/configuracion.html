{% extends "base.html" %}

{% block title %}Configuración - Iberdrola AI{% endblock %}

{% block content %}
<div class="use-case-container">
    <!-- Editor de Menú -->
    <div class="card">
        <div class="card-header">
            <h2>📝 Editor de Menú de Navegación</h2>
            <p style="font-size: 14px; color: var(--neutral-foreground-3); margin-top: 8px;">
                Personaliza los nombres y títulos del menú. Los cambios se guardan automáticamente.
            </p>
        </div>
        <div class="card-body">
            <div id="menu-editor">
                <!-- Dashboard -->
                <div class="menu-editor-section">
                    <h3 class="menu-editor-title">Dashboard</h3>
                    <div class="menu-editor-item">
                        <div class="form-group">
                            <label>Nombre en Menú</label>
                            <input type="text" class="form-control" 
                                   data-config-path="dashboard.menu_name" 
                                   value="{{ menu_config.dashboard.menu_name }}">
                        </div>
                        <div class="form-group">
                            <label>Título de Página</label>
                            <input type="text" class="form-control" 
                                   data-config-path="dashboard.page_title" 
                                   value="{{ menu_config.dashboard.page_title }}">
                        </div>
                    </div>
                </div>

                <!-- Categorías -->
                {% for category in menu_config.categories %}
                {% set category_index = loop.index0 %}
                <div class="menu-editor-section">
                    <h3 class="menu-editor-title">
                        <input type="text" class="form-control category-title-input" 
                               data-config-path="categories.{{ category_index }}.title" 
                               value="{{ category.title }}">
                    </h3>
                    
                    {% for item in category.menu_items %}
                    <div class="menu-editor-item">
                        <div class="menu-item-header">
                            <span class="menu-item-icon">{{ item.icon }}</span>
                            <span class="menu-item-endpoint">{{ item.endpoint }}</span>
                        </div>
                        <div class="form-group">
                            <label>Nombre en Menú</label>
                            <input type="text" class="form-control" 
                                   data-config-path="categories.{{ category_index }}.menu_items.{{ loop.index0 }}.menu_name" 
                                   value="{{ item.menu_name }}">
                        </div>
                        <div class="form-group">
                            <label>Título de Página</label>
                            <input type="text" class="form-control" 
                                   data-config-path="categories.{{ category_index }}.menu_items.{{ loop.index0 }}.page_title" 
                                   value="{{ item.page_title }}">
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}

                <!-- Configuración -->
                <div class="menu-editor-section">
                    <h3 class="menu-editor-title">Configuración</h3>
                    <div class="menu-editor-item">
                        <div class="form-group">
                            <label>Nombre en Menú</label>
                            <input type="text" class="form-control" 
                                   data-config-path="configuracion.menu_name" 
                                   value="{{ menu_config.configuracion.menu_name }}">
                        </div>
                        <div class="form-group">
                            <label>Título de Página</label>
                            <input type="text" class="form-control" 
                                   data-config-path="configuracion.page_title" 
                                   value="{{ menu_config.configuracion.page_title }}">
                        </div>
                    </div>
                </div>
            </div>

            <div class="menu-editor-actions">
                <button id="save-menu-config" class="btn btn-primary">
                    💾 Guardar Configuración
                </button>
                <button id="reset-menu-config" class="btn btn-secondary">
                    🔄 Restaurar Valores por Defecto
                </button>
                <div id="save-status" class="save-status"></div>
            </div>
        </div>
    </div>

    <!-- Vista del Menú -->
    <div class="card">
        <div class="card-header">
            <h2>🗂️ Organización del Menú</h2>
            <p style="font-size: 14px; color: var(--neutral-foreground-3); margin-top: 8px;">
                Configura cómo se agrupan los casos de uso en el menú lateral
            </p>
        </div>
        <div class="card-body">
            <div class="menu-view-selector">
                <div class="view-option" data-view="category">
                    <div class="view-option-header">
                        <input type="radio" name="menu_view" id="view_category" value="category" 
                               {% if menu_config.menu_view_mode == 'category' %}checked{% endif %}>
                        <label for="view_category">
                            <strong>📁 Por Categoría</strong>
                        </label>
                    </div>
                    <p class="view-option-description">
                        Agrupa los casos de uso según el esquema Iberdrola: Benchmark, Insights y Aprendizajes, Estudio Creativo, Content Automation, Brand Guardian
                    </p>
                    <div class="view-option-preview">
                        <div class="preview-item">1️⃣ Benchmark</div>
                        <div class="preview-subitem">→ Monitorización de marca</div>
                        <div class="preview-item">2️⃣ Insights y Aprendizajes</div>
                        <div class="preview-subitem">→ Predicción, Segmentación, Atribución</div>
                        <div class="preview-item">3️⃣ Estudio Creativo</div>
                        <div class="preview-subitem">→ Generación con GenAI</div>
                    </div>
                </div>

                <div class="view-option" data-view="roadmap">
                    <div class="view-option-header">
                        <input type="radio" name="menu_view" id="view_roadmap" value="roadmap"
                               {% if menu_config.menu_view_mode == 'roadmap' %}checked{% endif %}>
                        <label for="view_roadmap">
                            <strong>🚀 Por Roadmap</strong>
                        </label>
                    </div>
                    <p class="view-option-description">
                        Agrupa los casos de uso por fase de implementación: Quick Wins (Año 1) vs Año 2+
                    </p>
                    <div class="view-option-preview">
                        <div class="preview-item" style="color: #10b981;">🚀 Quick Wins (Año 1)</div>
                        <div class="preview-subitem">→ 4 casos de uso de rápida implementación</div>
                        <div class="preview-item" style="color: #3b82f6;">🎯 Año 2+ Wins</div>
                        <div class="preview-subitem">→ 6 casos de uso estratégicos</div>
                    </div>
                </div>
            </div>

            <div class="roadmap-info-box">
                <h4>📋 Distribución por Roadmap:</h4>
                <div class="roadmap-distribution">
                    <div class="roadmap-group quick-wins">
                        <h5>🚀 Quick Wins (Año 1)</h5>
                        <ul>
                            <li>📡 Monitorización de marca <span style="opacity:0.6">(Benchmark)</span></li>
                            <li>✍️ Generación de contenido con GenAI <span style="opacity:0.6">(Estudio Creativo)</span></li>
                            <li>🧪 A/B Testing Automatizado <span style="opacity:0.6">(Content Automation)</span></li>
                            <li>💬 Agentes Conversacionales <span style="opacity:0.6">(Brand Guardian)</span></li>
                        </ul>
                        <p class="roadmap-note">Baja dependencia de datos • Implementación rápida • Valor inmediato</p>
                    </div>
                    <div class="roadmap-group year-2-plus">
                        <h5>🎯 Año 2+ Wins</h5>
                        <ul>
                            <li>📈 Predicción de abandonos <span style="opacity:0.6">(Insights y Aprendizajes)</span></li>
                            <li>🔍 Segmentación de clientes <span style="opacity:0.6">(Insights y Aprendizajes)</span></li>
                            <li>🔗 Modelos de atribución <span style="opacity:0.6">(Insights y Aprendizajes)</span></li>
                            <li>👤 Personalización de experiencias <span style="opacity:0.6">(Content Automation)</span></li>
                            <li>🎁 Motor de recomendaciones <span style="opacity:0.6">(Content Automation)</span></li>
                            <li>🎯 Optimización Publicitaria <span style="opacity:0.6">(Brand Guardian)</span></li>
                        </ul>
                        <p class="roadmap-note">Alta dependencia de datos • Integración profunda • Visión estratégica</p>
                    </div>
                </div>
            </div>

            <button id="save-menu-view" class="btn btn-primary">
                💾 Aplicar Vista de Menú
            </button>
            <div id="view-save-status" class="save-status"></div>
        </div>
    </div>

    <!-- Configuración General -->
    <div class="card">
        <div class="card-header">
            <h2>⚙️ Configuración General</h2>
        </div>
        <div class="card-body">
            <form>
                <div class="form-group">
                    <label>Nombre de la Empresa</label>
                    <input type="text" class="form-control" value="Iberdrola España">
                </div>
                <div class="form-group">
                    <label>Idioma</label>
                    <select class="form-control">
                        <option selected>Español</option>
                        <option>English</option>
                        <option>Português</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Zona Horaria</label>
                    <select class="form-control">
                        <option selected>Europe/Madrid (GMT+1)</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Guardar Cambios</button>
            </form>
        </div>
    </div>

    <!-- Seguridad -->
    <div class="card">
        <div class="card-header">
            <h2>🔒 Seguridad y Privacidad</h2>
        </div>
        <div class="card-body">
            <div class="security-item">
                <div>
                    <strong>Autenticación de Dos Factores</strong>
                    <p>Protege tu cuenta con verificación adicional</p>
                </div>
                <label class="toggle">
                    <input type="checkbox" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="security-item">
                <div>
                    <strong>Certificación ISO/IEC 42001</strong>
                    <p>Sistema de Gestión de IA Certificado</p>
                </div>
                <span class="badge badge-success">✓ Activo</span>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const saveBtn = document.getElementById('save-menu-config');
    const resetBtn = document.getElementById('reset-menu-config');
    const saveStatus = document.getElementById('save-status');
    const saveViewBtn = document.getElementById('save-menu-view');
    const viewSaveStatus = document.getElementById('view-save-status');
    
    // Guardar vista de menú
    saveViewBtn.addEventListener('click', async function() {
        const selectedView = document.querySelector('input[name="menu_view"]:checked').value;
        
        try {
            const response = await fetch('/api/set-menu-view', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ view_mode: selectedView })
            });
            
            if (response.ok) {
                viewSaveStatus.innerHTML = '<span style="color: var(--success-color);">✓ Vista aplicada correctamente</span>';
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                viewSaveStatus.innerHTML = '<span style="color: var(--error-color);">✗ Error al cambiar vista</span>';
            }
        } catch (error) {
            viewSaveStatus.innerHTML = '<span style="color: var(--error-color);">✗ Error de conexión</span>';
        }
    });
    
    // Guardar configuración
    saveBtn.addEventListener('click', async function() {
        const inputs = document.querySelectorAll('#menu-editor input[data-config-path]');
        const config = {{ menu_config|tojson }};
        
        // Actualizar configuración con los valores de los inputs
        inputs.forEach(input => {
            const path = input.dataset.configPath.split('.');
            let obj = config;
            
            for (let i = 0; i < path.length - 1; i++) {
                obj = obj[path[i]];
            }
            
            obj[path[path.length - 1]] = input.value;
        });
        
        // Enviar al servidor
        try {
            const response = await fetch('/api/save-menu-config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(config)
            });
            
            if (response.ok) {
                saveStatus.innerHTML = '<span style="color: var(--success-color);">✓ Guardado correctamente</span>';
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                saveStatus.innerHTML = '<span style="color: var(--error-color);">✗ Error al guardar</span>';
            }
        } catch (error) {
            saveStatus.innerHTML = '<span style="color: var(--error-color);">✗ Error de conexión</span>';
        }
    });
    
    // Restaurar valores por defecto
    resetBtn.addEventListener('click', function() {
        if (confirm('¿Estás seguro de que quieres restaurar los valores por defecto?')) {
            fetch('/api/reset-menu-config', {
                method: 'POST'
            }).then(() => {
                window.location.reload();
            });
        }
    });
});
</script>

<!-- Incluir Asistente Virtual Fijo -->
{% include 'asistente_panel_fijo.html' %}

{% endblock %}
